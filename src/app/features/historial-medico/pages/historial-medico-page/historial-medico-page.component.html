<div class="page-container p-6 bg-gray-50 min-h-screen">

  <!-- Card de B√∫squeda -->
  <nz-card class="shadow-lg rounded-2xl border-0 overflow-hidden mb-6">
    <div class="flex items-center gap-4 mb-5">

      <h2 class="text-xl font-bold text-gray-900 m-0">üîçÔ∏é B√∫squeda de Historial M√©dico</h2>
    </div>

    <div nz-row [nzGutter]="[16, 16]" class="items-end">
      <!-- B√∫squeda por nombre de mascota -->
      <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="14" [nzLg]="16">
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <span nz-icon nzType="search" nzTheme="outline" class="mr-1"></span>
          ¬øQui√©n es la mascota?
        </label>
        <nz-input-group nzSize="large" [nzPrefix]="prefixIcon">
          <input nz-input placeholder="Buscar por nombre de mascota..." [ngModel]="petNameFilter()"
            (ngModelChange)="petNameFilter.set($event)" (keyup.enter)="onSearch()" />
        </nz-input-group>
        <ng-template #prefixIcon>
          <span nz-icon nzType="search" nzTheme="outline"></span>
        </ng-template>
      </div>

      <!-- Botones de acci√≥n -->
      <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="10" [nzLg]="8">
        <div class="flex gap-2 w-full">
          <button nz-button nzType="primary" nzSize="large" (click)="onSearch()" [nzLoading]="isLoading()"
            class="flex-1">
            <span nz-icon nzType="search"></span>
            Buscar
          </button>
          <button nz-button nzSize="large" (click)="clearFilters()" [disabled]="isLoading()" class="flex-1">
            <span nz-icon nzType="reload"></span>
            Limpiar
          </button>
        </div>
      </div>
    </div>
  </nz-card>

  <!-- Filtro por tipo de servicio -->
  <nz-card class="shadow-xl rounded-2xl border-0 overflow-hidden mb-6">
    <label class="block text-sm font-semibold text-gray-700 mb-3">Filtrar por Tipo de Servicio</label>
    <nz-radio-group [ngModel]="serviceTypeFilter()" (ngModelChange)="onServiceTypeChange($event)">
      <label nz-radio nzValue="TODOS">Todos</label>
      <label nz-radio nzValue="CITA">üìÖ Citas</label>
      <label nz-radio nzValue="VACUNA">üíâ Vacunas</label>
      <label nz-radio nzValue="CIRUG√çA">‚úÇÔ∏è Cirug√≠as</label>
    </nz-radio-group>
  </nz-card>

  <!-- Spinner de carga -->
  <nz-spin [nzSpinning]="isLoading()" nzSize="large">

    <!-- Sin resultados -->
    <div *ngIf="!isLoading() && filteredRecords().length === 0" class="text-center py-16">
      <span nz-icon nzType="file-search" nzTheme="outline" class="text-6xl text-gray-300 mb-4"></span>
      <p class="text-gray-500 text-lg">No hay registros m√©dicos disponibles</p>
    </div>

    <!-- Grid de Cards -->
    <div *ngIf="filteredRecords().length > 0" nz-row [nzGutter]="[16, 16]">
      <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12" [nzXl]="8" *ngFor="let record of filteredRecords()">

        <nz-card
          class="medical-card shadow-lg rounded-2xl border-0 hover:shadow-2xl transition-all duration-300 h-full">

          <!-- Header de la Card -->
          <div class="flex items-start justify-between mb-4 pb-4 border-b">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center"
                [ngStyle]="{'background-color': getServiceColorBg(record.event_type)}">
                <span nz-icon [nzType]="getServiceIcon(record.event_type)" nzTheme="fill" class="text-2xl"
                  [ngStyle]="{'color': getServiceColor(record.event_type)}"></span>
                <img [src]="record.pet.photo" alt="Foto de mascota" />

              </div>
              <div>
                <nz-tag [nzColor]="getServiceColor(record.event_type)" class="mb-1">
                  {{ record.event_type }}
                </nz-tag>
                <p class="text-xs text-gray-500 mb-0">
                  <span nz-icon nzType="calendar" nzTheme="outline"></span>
                  {{ formatDateDisplay(record.event_date) }}
                </p>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n de la Mascota -->
          <div class="mb-4 pb-4 border-b">
            <div class="flex items-center gap-2 mb-2">
              <span nz-icon nzType="heart" nzTheme="fill" class="text-pink-500"></span>
              <strong class="text-gray-800">Mascota</strong>
            </div>
            <div class="ml-6">
              <p class="mb-1 text-base font-semibold text-gray-900">{{ record.pet.name }}</p>
              <p class="text-sm text-gray-600 mb-0">
                {{ record.pet.species }} ¬∑ {{ record.pet.breed }}
              </p>
              <p class="text-xs text-gray-500 mb-0">
                Edad: {{ calculateAge(record.pet.birth_date) }} ¬∑ {{ record.pet.gender }}
              </p>
            </div>
          </div>

          <!-- Veterinario -->
          <div class="mb-4 pb-4 border-b">
            <div class="flex items-center gap-2 mb-2">
              <span nz-icon nzType="user" nzTheme="outline" class="text-blue-600"></span>
              <strong class="text-gray-800">Veterinario</strong>
            </div>
            <div class="ml-6">
              <p class="mb-1 text-sm font-medium text-gray-900">{{ record.service_veterinarian.username }}</p>
              <p class="text-xs text-gray-500 mb-0">{{ record.service_veterinarian.email }}</p>
            </div>
          </div>

          <!-- Detalles del Servicio -->
          <div class="mb-4 pb-4 border-b">
            <div class="flex items-center gap-2 mb-2">
              <span nz-icon nzType="file-text" nzTheme="outline" class="text-indigo-600"></span>
              <strong class="text-gray-800">Detalles</strong>
            </div>
            <div class="ml-6">
              <!-- CITA -->
              <div *ngIf="record.event_type === 'CITA' && record.service">
                <p class="text-xs text-gray-500 mb-1">Motivo de consulta:</p>
                <p class="text-sm text-gray-700 mb-0">{{ record.service.reason }}</p>
              </div>

              <!-- VACUNA -->
              <div *ngIf="record.event_type === 'VACUNA' && record.service">
                <p class="text-xs text-gray-500 mb-1">Vacunas aplicadas:</p>
                <p class="text-sm text-gray-700 mb-0">{{ record.service.vaccine_names }}</p>
              </div>

              <!-- CIRUG√çA -->
              <div *ngIf="record.event_type === 'CIRUG√çA' && record.service">
                <p class="text-xs text-gray-500 mb-1">Tipo de cirug√≠a:</p>
                <p class="text-sm text-gray-700 mb-1">{{ record.service.surgerie_type }}</p>
                <p class="text-xs text-gray-500 mb-1">Resultado:</p>
                <p class="text-sm text-gray-700 mb-0">{{ record.service.outcome }}</p>
              </div>

              <!-- Notas adicionales -->
              <div *ngIf="record.notes" class="mt-2 pt-2 border-t">
                <p class="text-xs text-gray-500 mb-1">Notas:</p>
                <p class="text-sm text-gray-600 italic mb-0">{{ record.notes }}</p>
              </div>
            </div>
          </div>

          <!-- Footer: Informaci√≥n de Pago -->
          <div *ngIf="record.service">
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div class="bg-green-50 rounded-lg p-3">
                <p class="text-xs text-gray-600 mb-1">Monto Total</p>
                <p class="text-lg font-bold text-green-600 mb-0">
                  S/ {{ record.service.monto | number: '1.2-2' }}
                </p>
              </div>
              <div class="bg-blue-50 rounded-lg p-3">
                <p class="text-xs text-gray-600 mb-1">Adelanto</p>
                <p class="text-lg font-bold text-blue-600 mb-0">
                  S/ {{ record.service.adelanto | number: '1.2-2' }}
                </p>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs text-gray-500 mb-1">Estado de Pago</p>
                <nz-tag [nzColor]="getPaymentStatusColor(record.service.state_payment)">
                  {{ record.service.state_payment | uppercase }}
                </nz-tag>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-500 mb-1">M√©todo de Pago</p>
                <p class="text-sm font-medium text-gray-700 mb-0">
                  <span nz-icon nzType="credit-card" nzTheme="outline"></span>
                  {{ record.service.metodo_pago }}
                </p>
              </div>
            </div>
          </div>

        </nz-card>
      </div>
    </div>

  </nz-spin>

</div>